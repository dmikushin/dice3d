// Pre3d, a JavaScript software 3d renderer.
// (c) Dean McNamee <dean@gmail.com>, Dec 2008.
var Pre3d=function(){function o(a,j){return a.x*j.x+a.y*j.y+a.z*j.z}function m(a,j){return{x:a.x-j.x,y:a.y-j.y}}function q(a,j){return{x:a.x+j.x,y:a.y+j.y,z:a.z+j.z}}function s(a,j){return{x:a.x*j,y:a.y*j}}function n(a,j){return{x:a.x*j,y:a.y*j,z:a.z*j}}function y(a){var j=a.x,a=a.y;return Math.sqrt(j*j+a*a)}function v(a){var j=a.x,b=a.y,a=a.z;return Math.sqrt(j*j+b*b+a*a)}function z(a){return s(a,1/y(a))}function B(a){return n(a,1/v(a))}function w(a,j,b,d,f,c,g,e,k,i,h,p){this.e0=a;this.e1=j;this.e2=
b;this.e3=d;this.e4=f;this.e5=c;this.e6=g;this.e7=e;this.e8=k;this.e9=i;this.e10=h;this.e11=p}function t(a,j){var b=a.e0,d=a.e1,f=a.e2,c=a.e4,g=a.e5,e=a.e6,k=a.e8,i=a.e9,h=a.e10,p=j.e0,l=j.e1,r=j.e2,o=j.e3,m=j.e4,E=j.e5,u=j.e6,q=j.e7,n=j.e8,t=j.e9,s=j.e10,v=j.e11;return new w(b*p+d*m+f*n,b*l+d*E+f*t,b*r+d*u+f*s,b*o+d*q+f*v+a.e3,c*p+g*m+e*n,c*l+g*E+e*t,c*r+g*u+e*s,c*o+g*q+e*v+a.e7,k*p+i*m+h*n,k*l+i*E+h*t,k*r+i*u+h*s,k*o+i*q+h*v+a.e11)}function C(a){var j=Math.sin(a),a=Math.cos(a);return new w(1,0,
0,0,0,a,-j,0,0,j,a,0)}function x(a){var j=Math.sin(a),a=Math.cos(a);return new w(a,0,j,0,0,1,0,0,-j,0,a,0)}function D(a){var j=Math.sin(a),a=Math.cos(a);return new w(a,-j,0,0,j,a,0,0,0,0,1,0)}function b(a,j){return{x:a.e0*j.x+a.e1*j.y+a.e2*j.z+a.e3,y:a.e4*j.x+a.e5*j.y+a.e6*j.z+a.e7,z:a.e8*j.x+a.e9*j.y+a.e10*j.z+a.e11}}function f(){this.reset()}function g(a,j){for(var d=j.length,f=Array(d),c=0;c<d;++c)f[c]=b(a,j[c]);return f}function d(a,j){var b=z(m(j,a));j.x+=b.x;j.y+=b.y;a.x-=b.x;a.y-=b.y}function c(a,
j,b,d){this.setRGBA(a,j,b,d)}function k(a,j,b,d){this.i0=a;this.i1=j;this.i2=b;this.i3=d;this.normal2=this.normal1=this.centroid=null}function e(a,j,b){this.ep=a;this.c0=j;this.c1=b}function i(){this.transform=new f;this.focal_length=1}function h(a){this.draw_overdraw=this.perform_z_sorting=!0;this.draw_backfaces=!1;this.texture=null;this.fill_rgba=new c(1,0,0,1);this.normal2_rgba=this.normal1_rgba=this.stroke_rgba=null;this.canvas=a;this.ctx=a.getContext("2d");this.camera=new i;this.transform=new f;
this.transform_stack_=[];this.quad_callback=null;this.width_=a.width;this.height_=a.height;this.scale_=this.height_/2;this.xoff_=this.width_/2;this.buffered_quads_=null;this.emptyBuffer();if(this.ctx.setStrokeColor==null)this.ctx.setStrokeColor=function(a,b,d,c){this.strokeStyle="rgba("+[Math.floor(a*255),Math.floor(b*255),Math.floor(d*255),c].join(",")+")"};if(this.ctx.setFillColor==null)this.ctx.setFillColor=function(a,b,d,c){this.fillStyle="rgba("+[Math.floor(a*255),Math.floor(b*255),Math.floor(d*
255),c].join(",")+")"}}function l(a,j,b,d,c,f,g,e,k,i,h,p,l,o){a.save();a.beginPath();a.moveTo(b,d);a.lineTo(c,f);a.lineTo(g,e);a.closePath();a.clip();var m=k*(o-p)-h*o+l*p+(h-l)*i;a.transform(-(i*(g-c)-p*g+o*c+(p-o)*b)/m,(p*e+i*(f-e)-o*f+(o-p)*d)/m,(k*(g-c)-h*g+l*c+(h-l)*b)/m,-(h*e+k*(f-e)-l*f+(l-h)*d)/m,(k*(o*c-p*g)+i*(h*g-l*c)+(l*p-h*o)*b)/m,(k*(o*f-p*e)+i*(h*e-l*f)+(l*p-h*o)*d)/m);a.drawImage(j,0,0);a.restore()}function u(a,j){return a.qf.centroid.z-j.qf.centroid.z}f.prototype.reset=function(){this.m=
new w(1,0,0,0,0,1,0,0,0,0,1,0)};f.prototype.rotateX=function(a){this.m=t(C(a),this.m)};f.prototype.rotateXPre=function(a){this.m=t(this.m,C(a))};f.prototype.rotateY=function(a){this.m=t(x(a),this.m)};f.prototype.rotateYPre=function(a){this.m=t(this.m,x(a))};f.prototype.rotateZ=function(a){this.m=t(D(a),this.m)};f.prototype.rotateZPre=function(a){this.m=t(this.m,D(a))};f.prototype.translate=function(a,j,b){this.m=t(new w(1,0,0,a,0,1,0,j,0,0,1,b),this.m)};f.prototype.translatePre=function(a,j,b){this.m=
t(this.m,new w(1,0,0,a,0,1,0,j,0,0,1,b))};f.prototype.scale=function(a,j,b){this.m=t(new w(a,0,0,0,0,j,0,0,0,0,b,0),this.m)};f.prototype.scalePre=function(a,b,d){this.m=t(this.m,new w(a,0,0,0,0,b,0,0,0,0,d,0))};f.prototype.transformPoint=function(a){return b(this.m,a)};f.prototype.multTransform=function(a){this.m=t(this.m,a.m)};f.prototype.setDCM=function(a,b,d){var c=this.m;c.e0=a.x;c.e4=a.y;c.e8=a.z;c.e1=b.x;c.e5=b.y;c.e9=b.z;c.e2=d.x;c.e6=d.y;c.e10=d.z};f.prototype.dup=function(){var a=new f;a.m=
new w(this.m.e0,this.m.e1,this.m.e2,this.m.e3,this.m.e4,this.m.e5,this.m.e6,this.m.e7,this.m.e8,this.m.e9,this.m.e10,this.m.e11);return a};c.prototype.setRGBA=function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=d};c.prototype.setRGB=function(a,b,c){this.setRGBA(a,b,c,1)};c.prototype.invert=function(){this.r=1-this.r;this.g=1-this.g;this.b=1-this.b};c.prototype.dup=function(){return new c(this.r,this.g,this.b,this.a)};k.prototype.isTriangle=function(){return this.i3===null};k.prototype.setQuad=function(a,
b,c,d){this.i0=a;this.i1=b;this.i2=c;this.i3=d};k.prototype.setTriangle=function(a,b,c){this.i0=a;this.i1=b;this.i2=c;this.i3=null};e.prototype.isQuadratic=function(){return this.c1===null};e.prototype.setQuadratic=function(a,b){this.ep=a;this.c0=b;this.c1=null};e.prototype.setCubic=function(a,b,c){this.ep=a;this.c0=b;this.c1=c};h.prototype.pushTransform=function(){this.transform_stack_.push(this.transform.dup())};h.prototype.popTransform=function(){this.transform=this.transform_stack_.pop()};h.prototype.emptyBuffer=
function(){this.buffered_quads_=[]};h.prototype.projectPointToCanvas=function(a){var b=this.camera.focal_length/-a.z,c=this.scale_;return{x:a.x*b*c+this.xoff_,y:a.y*b*-c+c}};h.prototype.projectPointsToCanvas=function(a){for(var b=a.length,c=Array(b),d=0;d<b;++d)c[d]=this.projectPointToCanvas(a[d]);return c};h.prototype.projectQuadFaceToCanvasIP=function(a){a.i0=this.projectPointToCanvas(a.i0);a.i1=this.projectPointToCanvas(a.i1);a.i2=this.projectPointToCanvas(a.i2);if(!a.isTriangle())a.i3=this.projectPointToCanvas(a.i3);
return a};var E={x:0,y:0,z:1};h.prototype.bufferShape=function(a){var c=this.draw_backfaces,d=this.quad_callback,f=t(this.camera.transform.m,this.transform.m),e;e=f.e0;var h=f.e1,i=f.e2,l=f.e4,m=f.e5,u=f.e6,q=f.e8,p=f.e9,n=f.e10;e=new w(n*m-u*p,u*q-l*n,l*p-q*m,0,i*p-n*h,n*e-i*q,q*h-e*p,0,u*h-i*m,l*i-u*e,e*m-l*h,0);h=g(f,a.vertices);i=a.quads;l=0;for(m=a.quads.length;l<m;++l){var r=i[l];if(!(d!==null&&d(r,l,a)===!0)&&(u=b(f,r.centroid),!(u.z>=-1)&&(q=B(b(e,r.normal1)),p=b(e,r.normal2),!(c!==!0&&o(u,
q)>0&&o(u,p)>0))))n=o(E,q),n<0&&(n=0),r=r.isTriangle()===!0?new k(h[r.i0],h[r.i1],h[r.i2],null):new k(h[r.i0],h[r.i1],h[r.i2],h[r.i3]),r.centroid=u,r.normal1=q,r.normal2=p,this.buffered_quads_.push({qf:r,intensity:n,draw_overdraw:this.draw_overdraw,texture:this.texture,fill_rgba:this.fill_rgba,stroke_rgba:this.stroke_rgba,normal1_rgba:this.normal1_rgba,normal2_rgba:this.normal2_rgba})}};h.prototype.drawBackground=function(){this.ctx.fillRect(0,0,this.width_,this.height_)};h.prototype.clearBackground=
function(){this.ctx.clearRect(0,0,this.width_,this.height_)};h.prototype.drawBuffer=function(){var a=this.ctx,b=this.buffered_quads_,c=b.length;this.perform_z_sorting===!0&&b.sort(u);for(var f=0;f<c;++f){var g=b[f],e=g.qf;this.projectQuadFaceToCanvasIP(e);var h=e.isTriangle();g.draw_overdraw===!0&&(d(e.i0,e.i1),d(e.i1,e.i2),h===!0?d(e.i2,e.i0):(d(e.i2,e.i3),d(e.i3,e.i0)));a.beginPath();a.moveTo(e.i0.x,e.i0.y);a.lineTo(e.i1.x,e.i1.y);a.lineTo(e.i2.x,e.i2.y);h!==!0&&a.lineTo(e.i3.x,e.i3.y);var i=g.fill_rgba;
if(i!==null){var k=g.intensity;a.setFillColor(i.r*k,i.g*k,i.b*k,i.a);a.fill()}i=g.texture;i!==null&&(l(a,i.image,e.i0.x,e.i0.y,e.i1.x,e.i1.y,e.i2.x,e.i2.y,i.u0,i.v0,i.u1,i.v1,i.u2,i.v2),h||l(a,i.image,e.i0.x,e.i0.y,e.i2.x,e.i2.y,e.i3.x,e.i3.y,i.u0,i.v0,i.u2,i.v2,i.u3,i.v3));h=g.stroke_rgba;h!==null&&(a.closePath(),a.setStrokeColor(h.r,h.g,h.b,h.a),a.stroke());h=g.normal1_rgba;g=g.normal2_rgba;h!==null&&(a.setStrokeColor(h.r,h.g,h.b,h.a),h=this.projectPointToCanvas(e.centroid),i=this.projectPointToCanvas(q(e.centroid,
B(e.normal1))),a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(i.x,i.y),a.stroke());g!==null&&(a.setStrokeColor(g.r,g.g,g.b,g.a),h=this.projectPointToCanvas(e.centroid),i=this.projectPointToCanvas(q(e.centroid,B(e.normal2))),a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(i.x,i.y),a.stroke())}return c};h.prototype.drawPath=function(a,c){var d=this.ctx,c=c||{},e=t(this.camera.transform.m,this.transform.m),f=this.projectPointsToCanvas(g(e,a.points)),e=a.starting_point===null?this.projectPointToCanvas(b(e,{x:0,y:0,
z:0})):f[a.starting_point];d.beginPath();d.moveTo(e.x,e.y);for(var e=a.curves,h=0,i=e.length;h<i;++h){var k=e[h];if(k.isQuadratic()===!0){var l=f[k.c0],k=f[k.ep];d.quadraticCurveTo(l.x,l.y,k.x,k.y)}else{var l=f[k.c0],o=f[k.c1],k=f[k.ep];d.bezierCurveTo(l.x,l.y,o.x,o.y,k.x,k.y)}}c.fill===!0?d.fill():d.stroke()};return{RGBA:c,AffineMatrix:w,Transform:f,QuadFace:k,Shape:function(){this.vertices=[];this.quads=[]},Curve:e,Path:function(){this.points=[];this.curves=[];this.starting_point=null},Camera:i,
TextureInfo:function(){this.v3=this.u3=this.v2=this.u2=this.v1=this.u1=this.v0=this.u0=this.image=null},Renderer:h,Math:{crossProduct:function(a,b){return{x:a.y*b.z-a.z*b.y,y:a.z*b.x-a.x*b.z,z:a.x*b.y-a.y*b.x}},dotProduct2d:function(a,b){return a.x*b.x+a.y*b.y},dotProduct3d:o,subPoints2d:m,subPoints3d:function(a,b){return{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z}},addPoints2d:function(a,b){return{x:a.x+b.x,y:a.y+b.y}},addPoints3d:q,mulPoint2d:s,mulPoint3d:n,vecMag2d:y,vecMag3d:v,unitVector2d:z,unitVector3d:B,
linearInterpolate:function(a,b,c){return(b-a)*c+a},linearInterpolatePoints3d:function(a,b,c){return{x:(b.x-a.x)*c+a.x,y:(b.y-a.y)*c+a.y,z:(b.z-a.z)*c+a.z}},averagePoints:function(a){for(var b={x:0,y:0,z:0},c=0,d=a.length;c<d;++c){var e=a[c];b.x+=e.x;b.y+=e.y;b.z+=e.z}a=1/d;b.x*=a;b.y*=a;b.z*=a;return b}}}}();Pre3d.ShapeUtils=function(){function o(b){for(var f=b.quads,g=f.length,d=b.vertices,c=0;c<g;++c){var k=f[c],e,i,h;e=d[k.i0];var l=d[k.i1],o=d[k.i2];i=v(l,e);h=v(o,e);i=y(i,h);if(k.isTriangle())h=i,e=x([e,l,o]);else{var m=d[k.i3],a=v(m,e);h=y(h,a);e=x([e,l,o,m])}k.centroid=e;k.normal1=i;k.normal2=h}return b}function m(b,f,g){var d=new Pre3d.Shape;d.vertices=[{x:b,y:f,z:-g},{x:b,y:f,z:g},{x:b,y:-f,z:g},{x:b,y:-f,z:-g},{x:-b,y:f,z:-g},{x:-b,y:f,z:g},{x:-b,y:-f,z:g},{x:-b,y:-f,z:-g}];d.quads=[new Pre3d.QuadFace(0,
1,2,3),new Pre3d.QuadFace(1,5,6,2),new Pre3d.QuadFace(5,4,7,6),new Pre3d.QuadFace(4,0,3,7),new Pre3d.QuadFace(0,4,5,1),new Pre3d.QuadFace(2,6,7,3)];o(d);return d}function q(b,f,g){for(var d=[],c=[],k=Math.PI/(g+1),e=D/f,i=0,h=k;i<g;++i,h+=k)for(var l=0;l<f;++l)d.push(b(h,e*l));for(i=0;i<g-1;++i){k=i*f;for(l=0;l<f;++l)e=(l+1)%f,c.push(new Pre3d.QuadFace(k+l,k+f+l,k+f+e,k+e))}g=d.length-f;l=d.length;k=l+1;d.push(b(0,0));d.push(b(Math.PI,0));for(i=0;i<f;++i)c.push(new Pre3d.QuadFace(l,i,(i+1)%f,null)),
c.push(new Pre3d.QuadFace(k,g+(i+2)%f,g+(i+1)%f,null));b=new Pre3d.Shape;b.vertices=d;b.quads=c;o(b);return b}function s(b,f){for(var g=Array(b.length),d=0,c=b.length;d<c;++d)g[d]=f(b[d],d,b);return g}function n(){this.count_=this.distance_=1;this.selector_=null;this.selectAll();this.scale={x:1,y:1,z:1};this.rotate={x:0,y:0,z:0}}var y=Pre3d.Math.crossProduct,v=Pre3d.Math.subPoints3d,z=Pre3d.Math.addPoints3d,B=Pre3d.Math.mulPoint3d,w=Pre3d.Math.unitVector3d,t=Pre3d.Math.linearInterpolate,C=Pre3d.Math.linearInterpolatePoints3d,
x=Pre3d.Math.averagePoints,D=Math.PI*2;n.prototype.selectAll=function(){this.selector_=function(){return!0}};n.prototype.selectCustom=function(b){this.selector_=b};n.prototype.distance=function(){return this.distance_};n.prototype.set_distance=function(b){this.distance_=b};n.prototype.count=function(){return this.count_};n.prototype.set_count=function(b){this.count_=b};n.prototype.extrude=function(b){for(var f=this.distance(),g=this.count(),d=this.rotate.x,c=this.rotate.y,k=this.rotate.z,e=this.scale.x,
i=this.scale.y,h=this.scale.z,l=b.vertices,m=b.quads,q=[],a=0,j=m.length;a<j;++a)this.selector_(b,a)&&q.push(a);a=0;for(j=q.length;a<j;++a){var n=m[q[a]],s=n.centroid,y=w(z(n.normal1,n.normal2)),x=n.isTriangle(),C=v(l[n.i0],s),D=v(l[n.i1],s),G=v(l[n.i2],s);if(x!==!0)var H=v(l[n.i3],s);for(var F=0;F<g;++F){var p=(F+1)/g,A=new Pre3d.Transform;A.rotateX(d*p);A.rotateY(c*p);A.rotateZ(k*p);var r=z(s,B(A.transformPoint(y),p*f));A.scalePre(t(1,e,p),t(1,i,p),t(1,h,p));p=l.length;l.push(z(r,A.transformPoint(C)));
l.push(z(r,A.transformPoint(D)));l.push(z(r,A.transformPoint(G)));x!==!0&&l.push(z(r,A.transformPoint(H)));m.push(new Pre3d.QuadFace(n.i1,p+1,p,n.i0));m.push(new Pre3d.QuadFace(n.i2,p+2,p+1,n.i1));x===!0?m.push(new Pre3d.QuadFace(n.i0,p,p+2,n.i2)):(m.push(new Pre3d.QuadFace(n.i3,p+3,p+2,n.i2)),m.push(new Pre3d.QuadFace(n.i0,p,p+3,n.i3)));n.i0=p;n.i1=p+1;n.i2=p+2;if(x!==!0)n.i3=p+3}}o(b)};return{rebuildMeta:o,triangulate:function(b){for(var f=b.quads,g=f.length,d=0;d<g;++d){var c=f[d];if(!c.isTriangle()){var k=
new Pre3d.QuadFace(c.i0,c.i2,c.i3,null);c.i3=null;f.push(k)}}o(b);return b},forEachFace:function(b,f){for(var g=b.quads,d=0,c=g.length;d<c;++d)if(f(g[d],d,b)===!0)break;return b},forEachVertex:function(b,f){for(var g=b.vertices,d=0,c=g.length;d<c;++d)if(f(g[d],d,b)===!0)break;return b},makePlane:function(b,f,g,d){var c=new Pre3d.Shape;c.vertices=[b,f,g,d];c.quads=[new Pre3d.QuadFace(0,1,2,3)];o(c);return c},makeCube:function(b){return m(b,b,b)},makeBox:m,makeBoxWithHole:function(b,f,g,d,c){var k=
new Pre3d.Shape;k.vertices=[{x:b,y:f,z:-g},{x:b,y:f,z:g},{x:b,y:-f,z:g},{x:b,y:-f,z:-g},{x:-b,y:f,z:-g},{x:-b,y:f,z:g},{x:-b,y:-f,z:g},{x:-b,y:-f,z:-g},{x:d,y:f,z:g},{x:b,y:c,z:g},{x:d,y:c,z:g},{x:d,y:-f,z:g},{x:b,y:-c,z:g},{x:d,y:-c,z:g},{x:-d,y:f,z:g},{x:-b,y:c,z:g},{x:-d,y:c,z:g},{x:-d,y:-f,z:g},{x:-b,y:-c,z:g},{x:-d,y:-c,z:g},{x:d,y:f,z:-g},{x:b,y:c,z:-g},{x:d,y:c,z:-g},{x:d,y:-f,z:-g},{x:b,y:-c,z:-g},{x:d,y:-c,z:-g},{x:-d,y:f,z:-g},{x:-b,y:c,z:-g},{x:-d,y:c,z:-g},{x:-d,y:-f,z:-g},{x:-b,y:-c,
z:-g},{x:-d,y:-c,z:-g}];k.quads=[new Pre3d.QuadFace(1,8,10,9),new Pre3d.QuadFace(8,14,16,10),new Pre3d.QuadFace(14,5,15,16),new Pre3d.QuadFace(16,15,18,19),new Pre3d.QuadFace(19,18,6,17),new Pre3d.QuadFace(13,19,17,11),new Pre3d.QuadFace(12,13,11,2),new Pre3d.QuadFace(9,10,13,12),new Pre3d.QuadFace(4,26,28,27),new Pre3d.QuadFace(26,20,22,28),new Pre3d.QuadFace(20,0,21,22),new Pre3d.QuadFace(22,21,24,25),new Pre3d.QuadFace(25,24,3,23),new Pre3d.QuadFace(31,25,23,29),new Pre3d.QuadFace(30,31,29,7),
new Pre3d.QuadFace(27,28,31,30),new Pre3d.QuadFace(10,16,28,22),new Pre3d.QuadFace(19,31,28,16),new Pre3d.QuadFace(13,25,31,19),new Pre3d.QuadFace(10,22,25,13),new Pre3d.QuadFace(6,7,29,17),new Pre3d.QuadFace(17,29,23,11),new Pre3d.QuadFace(11,23,3,2),new Pre3d.QuadFace(1,9,21,0),new Pre3d.QuadFace(9,12,24,21),new Pre3d.QuadFace(12,2,3,24),new Pre3d.QuadFace(5,4,27,15),new Pre3d.QuadFace(15,27,30,18),new Pre3d.QuadFace(18,30,7,6),new Pre3d.QuadFace(14,26,4,5),new Pre3d.QuadFace(8,20,26,14),new Pre3d.QuadFace(1,
0,20,8)];o(k);return k},makeSphericalShape:q,makeSphere:function(b,f,g){return q(function(d,c){return{x:b*Math.sin(d)*Math.sin(c),y:b*Math.cos(d),z:b*Math.sin(d)*Math.cos(c)}},f,g)},makeOctahedron:function(){var b=new Pre3d.Shape;b.vertices=[{x:-1,y:0,z:0},{x:0,y:0,z:1},{x:1,y:0,z:0},{x:0,y:0,z:-1},{x:0,y:1,z:0},{x:0,y:-1,z:0}];quads=Array(8);for(var f=0;f<4;++f){var g=f+1&3;quads[f*2]=new Pre3d.QuadFace(4,f,g,null);quads[f*2+1]=new Pre3d.QuadFace(f,5,g,null)}b.quads=quads;Pre3d.ShapeUtils.rebuildMeta(b);
return b},averageSmooth:function(b,f){f===void 0&&(f=1);for(var g=b.vertices,d=g.length,c=Array(d),k=Array(d),e=0;e<d;++e)k[e]=[];e=0;for(d=b.quads.length;e<d;++e){var i=b.quads[e];k[i.i0].push(e);k[i.i1].push(e);k[i.i2].push(e);i.isTriangle()||k[i.i3].push(e)}e=0;for(d=g.length;e<d;++e){for(var h=k[e],i={x:0,y:0,z:0},l=0,n=h.length;l<n;++l){var m=b.quads[h[l]],a=g[m.i0],j=g[m.i1],q=g[m.i2],m=g[m.i3];i.x+=(a.x+j.x+q.x+m.x)/4;i.y+=(a.y+j.y+q.y+m.y)/4;i.z+=(a.z+j.z+q.z+m.z)/4}h=1/n;i.x*=h;i.y*=h;i.z*=
h;c[e]=C(g[e],i,f)}b.vertices=c;o(b);return b},linearSubdivide:function(b){for(var f=b.quads.length,g={},d=0;d<f;++d){for(var c=b.quads[d],k=c.i0,e=c.i1,i=c.i2,c=c.i3,h=[[k,e].sort(),[e,i].sort(),[i,c].sort(),[c,k].sort(),[k,e,i,c].sort()],l=0,m=h.length;l<m;++l){var n=h[l],a=n.join("-"),j=g[a];if(j===void 0){var j=b.vertices.length,q=b;b.vertices.push(x(s(n,function(a){return q.vertices[a]})));g[a]=j}h[l]=j}k=new Pre3d.QuadFace(k,h[0],h[4],h[3]);e=new Pre3d.QuadFace(h[0],e,h[1],h[4]);i=new Pre3d.QuadFace(h[4],
h[1],i,h[2]);c=new Pre3d.QuadFace(h[3],h[4],h[2],c);b.quads[d]=k;b.quads.push(e);b.quads.push(i);b.quads.push(c)}o(b);return b},linearSubdivideTri:function(b){for(var f=b.quads.length,g={},d=0;d<f;++d){for(var c=b.quads[d],k=c.i0,e=c.i1,i=c.i2,c=[[k,e].sort(),[e,i].sort(),[i,k].sort()],h=0,l=c.length;h<l;++h){var m=c[h],n=m.join("-"),a=g[n];if(a===void 0){var a=b.vertices.length,j=b;b.vertices.push(x(s(m,function(a){return j.vertices[a]})));g[n]=a}c[h]=a}k=new Pre3d.QuadFace(k,c[0],c[2],null);e=new Pre3d.QuadFace(c[0],
e,c[1],null);i=new Pre3d.QuadFace(c[2],c[1],i,null);c=new Pre3d.QuadFace(c[0],c[1],c[2],null);b.quads[d]=k;b.quads.push(e);b.quads.push(i);b.quads.push(c)}o(b);return b},explodeFaces:function(b){for(var f=b.quads,g=f.length,d=b.vertices,c=[],k=0;k<g;++k){var e=f[k],i=c.length;c.push({x:d[e.i0].x,y:d[e.i0].y,z:d[e.i0].z});c.push({x:d[e.i1].x,y:d[e.i1].y,z:d[e.i1].z});c.push({x:d[e.i2].x,y:d[e.i2].y,z:d[e.i2].z});e.i0=i;e.i1=i+1;e.i2=i+2;if(e.isTriangle()!==!0)c.push({x:d[e.i3].x,y:d[e.i3].y,z:d[e.i3].z}),
e.i3=i+3}b.vertices=c;return b},Extruder:n}}();Pre3d.PathUtils=function(){return{makeLine:function(o,m){var q=new Pre3d.Path;q.points=[{x:o.x,y:o.y,z:o.z},{x:m.x,y:m.y,z:m.z}];q.curves=[new Pre3d.Curve(1,1,1)];q.starting_point=0;return q},makeCircle:function(){var o=new Pre3d.Path;o.points=[{x:0,y:0.66666666666,z:0},{x:1,y:0.66666666666,z:0},{x:1,y:0,z:0},{x:1,y:-0.66666666666,z:0},{x:0,y:-0.66666666666,z:0},{x:0,y:0,z:0}];o.curves=[new Pre3d.Curve(2,0,1),new Pre3d.Curve(5,3,4)];return o},makeSpiral:function(o){for(var m=[],q=[],s=0,n=0,y=0;y<
o;++y)m.push({x:0,y:0.66666666666,z:s}),s-=0.05,m.push({x:1,y:0.66666666666,z:s}),m.push({x:1,y:0,z:s}),m.push({x:1,y:-0.66666666666,z:s}),s-=0.05,m.push({x:0,y:-0.66666666666,z:s}),m.push({x:0,y:0,z:s}),q.push(new Pre3d.Curve(n+2,n+0,n+1)),q.push(new Pre3d.Curve(n+5,n+3,n+4)),n+=6;o=new Pre3d.Path;o.points=m;o.curves=q;return o},fitQuadraticToPoints:function(o,m,q){return{x:m.x+m.x-0.5*(o.x+q.x),y:m.y+m.y-0.5*(o.y+q.y),z:m.z+m.z-0.5*(o.z+q.z)}}}}();
